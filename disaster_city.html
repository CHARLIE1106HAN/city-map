
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²ç½åŸå¸‚æ¨¡æ“¬å™¨ - åœ–åƒåŒ–ç‰ˆæœ¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Baloo+2:wght@700;800&display=swap');
        :root {
            --font-main: 'Noto Sans TC', sans-serif;
            --font-display: 'Baloo 2', cursive;
            --sky-top: #87CEEB;
            --sky-bottom: #B0E0E6;
            --plains-color: #8BC34A;
            --mountains-color: #A1887F;
            --ground-color: #D2B48C;
            --action-color: #FF7043;
            --action-hover-color: #F4511E;
            --panel-bg: #FFFBE6;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: var(--font-main);
            overflow: hidden;
        }

        /* --- ä¸»è¦éŠæˆ²ä¸–ç•Œ --- */
        #game-world {
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, var(--sky-top) 0%, var(--sky-bottom) 60%, var(--plains-color) 60%, var(--ground-color) 100%);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- é ‚éƒ¨ç‹€æ…‹åˆ— --- */
        #top-bar {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.1);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .top-stat {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* --- éŠæˆ²å ´æ™¯å€åŸŸ --- */
        #scene {
            flex-grow: 1;
            display: flex;
            justify-content: space-around;
            align-items: flex-end; /* å°é½Šåº•éƒ¨ */
            padding: 20px;
            padding-bottom: 120px; /* ç‚ºæ§åˆ¶æŒ‰éˆ•ç•™å‡ºç©ºé–“ */
        }
        .area-container {
            width: 45%;
            height: 80%;
            display: flex;
            flex-direction: column;
        }
        .area-header {
            font-family: var(--font-display);
            font-size: 40px;
            text-align: center;
            color: white;
            padding: 10px;
            border-radius: 20px 20px 0 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #plains-container .area-header { background-color: var(--plains-color); }
        #mountains-container .area-header { background-color: var(--mountains-color); }

        .buildings-display {
            flex-grow: 1;
            background-color: rgba(255,255,255,0.3);
            border-radius: 0 0 20px 20px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
            overflow-y: auto;
        }
        .building-icon, .facility-icon {
            font-size: 36px; /* Emojis as icons */
            transition: transform 0.2s ease;
        }
        .building-icon:hover, .facility-icon:hover {
            transform: scale(1.2);
        }

        .area-stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            margin-top: -20px;
            position: relative;
        }
        .stat-bubble {
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 18px;
            font-weight: bold;
        }

        /* --- æ§åˆ¶æŒ‰éˆ• --- */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 30px;
        }
        .control-button {
            padding: 15px 40px;
            font-family: var(--font-display);
            font-size: 24px;
            border: none;
            border-radius: 50px;
            color: white;
            background-color: var(--action-color);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .control-button:hover {
            background-color: var(--action-hover-color);
            transform: translateY(-3px);
        }
        #next-month-button { background-color: #4CAF50; }
        #next-month-button:hover { background-color: #45a049; }


        /* --- å½ˆå‡ºè¦–çª— (æ²¿ç”¨ï¼Œç¨ä½œç¾åŒ–) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: var(--panel-bg);
            padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 80%; max-width: 600px;
            max-height: 80vh;
            display: flex; flex-direction: column;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { font-family: var(--font-display); font-size: 32px; margin-top: 0; text-align: center; }
        .modal-body { overflow-y: auto; padding: 10px; }
        .modal-close-button { align-self: center; margin-top: 20px; padding: 10px 30px; font-size: 18px; border-radius: 30px; background: #888; color: white; border: none; cursor: pointer; }

        /* ... [å…¶ä»–å½ˆå‡ºè¦–çª—æ¨£å¼èˆ‡å‰ä¸€ç‰ˆç›¸åŒ] ... */
        .build-category { margin-bottom: 20px; }
        .build-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #fff; border-radius: 8px; margin-bottom: 8px; }
        .build-item-name { font-size: 18px; font-weight: bold; }
        .build-item-cost { color: #888; }
        .build-controls { display: flex; align-items: center; gap: 10px; }
        .build-controls input { width: 50px; text-align: center; font-size: 16px; padding: 5px;}
        .build-controls button, .upgrade-button { padding: 5px 15px; font-size: 16px; background: var(--action-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        #event-log { list-style: none; padding: 0; background: #fff; border-radius: 10px; padding: 15px; }
        #event-log li { padding: 8px 0; border-bottom: 1px solid #eee; }
        #event-log li:last-child { border-bottom: none; }

        /* æ–°å¢çš„ä¿®å¾©æŒ‰éˆ•æ¨£å¼ */
        .repair-button {
            background-color: #007bff; /* è—è‰² */
        }
        .repair-button:hover {
            background-color: #0056b3;
        }
        /* æ–°å¢çš„å€åŸŸé¸æ“‡æŒ‰éˆ•æ¨£å¼ */
        .area-select-button {
            background-color: #6c757d;
            margin-left: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .area-select-button:hover {
            background-color: #5a6268;
        }

    </style>
</head>
<body>

    <div id="game-world">
        <div id="top-bar">
            <div id="month-stat" class="top-stat">ğŸ“… ç¬¬ 0 æœˆ</div>
            <div id="population-stat" class="top-stat">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ç¸½äººå£: 100</div>
            <div id="gold-stat" class="top-stat">ğŸ’° é‡‘å¹£: 20000</div>
            <div id="debt-stat" class="top-stat" style="display:none;">ğŸ’¸ å‚µå‹™: 0</div>
        </div>

        <div id="scene">
            <div id="plains-container" class="area-container">
                <div class="area-header">ğŸï¸ å¹³åœ°å€</div>
                <div class="area-stats">
                    <div class="stat-bubble">ğŸ§‘â€ğŸ¤â€ğŸ§‘ <span id="plains-population">60</span></div>
                    <div class="stat-bubble">â˜ ï¸ <span id="plains-homeless">0</span></div>
                    <div class="stat-bubble">ğŸ¤’ <span id="plains-sick">0</span></div>
                    <div class="stat-bubble">ğŸšï¸ <span id="plains-damaged-houses">0</span></div>
                </div>
                <div id="plains-buildings" class="buildings-display"></div>
            </div>

            <div id="mountains-container" class="area-container">
                <div class="area-header">ğŸ”ï¸ å±±åœ°å€</div>
                <div class="area-stats">
                    <div class="stat-bubble">ğŸ§‘â€ğŸ¤â€ğŸ§‘ <span id="mountains-population">40</span></div>
                    <div class="stat-bubble">â˜ ï¸ <span id="mountains-homeless">0</span></div>
                    <div class="stat-bubble">ğŸ¤’ <span id="mountains-sick">0</span></div>
                    <div class="stat-bubble">ğŸšï¸ <span id="mountains-damaged-houses">0</span></div>
                </div>
                <div id="mountains-buildings" class="buildings-display"></div>
            </div>
        </div>

        <div id="controls">
            <button id="build-button" class="control-button">âš’ï¸ å»ºé€ </button>
            <button id="loan-button" class="control-button" style="background-color: #9C27B0;">ğŸ’¸ å€Ÿè²¸</button>
            <button id="next-month-button" class="control-button">â¡ï¸ ä¸‹ä¸€æœˆ</button>
        </div>
    </div>

    <div id="build-modal" class="modal-overlay"></div>
    <div id="event-modal" class="modal-overlay"></div>
    <div id="instructions-modal" class="modal-overlay visible"></div>
    <div id="loan-modal" class="modal-overlay"></div>

    <script>
    let gameState = {};

    const facilityMaster = {
        "é†«é™¢": { id: "hospital", cost: 5000, name: "é†«é™¢", icon: "ğŸ¥", area: "any" },
        "æ“‹åœŸç‰†": { id: "retainingWall", cost: 4000, name: "æ“‹åœŸç‰†", icon: "ğŸ§±", area: "mountain" },
        "æ°´å£©": { id: "dam", cost: 4000, name: "æ°´å£©", icon: " ğŸ›Ÿ", area: "plains" },
        "åœ°éœ‡é è­¦ç³»çµ±": { id: "earthquakeWarning", cost: 3500, name: "åœ°éœ‡é è­¦ç³»çµ±", icon: "ğŸ“¡", area: "any" },
        "ç¤¦å ´": { id: "mine", cost: 4000, name: "ç¤¦å ´", icon: "â›ï¸", area: "mountain" },
        "åŸºç¤è¾²ç”°": { id: "farm", cost: 3000, name: "åŸºç¤è¾²ç”°", icon: "ğŸŒ¾", area: "plains" },
        "é¿é›£ä¸­å¿ƒ": { id: "shelter", cost: 1500, name: "é¿é›£ä¸­å¿ƒ", icon: "â›º", area: "any" }
    };
    const houseMaster = {
        "æˆ¿å±‹1": { id: "house1", cost: 1000, name: "ä¸€ç´šæˆ¿å±‹", icon: "ğŸ " },
        "æˆ¿å±‹2": { id: "house2", cost: 2000, name: "äºŒç´šæˆ¿å±‹", icon: "ğŸ¡" },
        "æˆ¿å±‹3": { id: "house3", cost: 3000, name: "ä¸‰ç´šæˆ¿å±‹", icon: "ğŸ˜ï¸" }
    };

    function resetGame() {
        gameState = {
            gold: 20000,
            currentMonth: 0,
            rainCount: 0,
            majorDisasterMonth: Math.floor(Math.random() * 12) + 1,
            majorDisasterType: ["ç«å±±çˆ†ç™¼", "éš•çŸ³æ‰è½", "è¶…ç´šé¢±é¢¨"][Math.floor(Math.random() * 3)],
            buildings: {
                mountain: { house1: 10, house2: 0, house3: 0 },
                plains: { house1: 10, house2: 0, house3: 0 }
            },
            population: { mountain: 40, plains: 60 },
            homeless: { mountain: 0, plains: 0 },
            damagedHouses: { mountain: 0, plains: 0 },
            // è¨­æ–½ç¾åœ¨ä¹ŸæŒ‰å€åŸŸåˆ†é¡
            facilities: {
                mountain: { hospital: 0, retainingWall: 0, dam: 0, earthquakeWarning: 0, mine: 0, farm: 0, shelter: 0 },
                plains: { hospital: 0, retainingWall: 0, dam: 0, earthquakeWarning: 0, mine: 0, farm: 0, shelter: 0 },
                global: { hospital: 0, earthquakeWarning: 0, shelter: 0 } // ç”¨æ–¼è¨ˆç®—å…¨åŸŸæ•ˆæœçš„è¨­æ–½ç¸½æ•¸
            },
            sickness: { mountain: [], plains: [] },
            inTreatment: [],
            eventLog: [],
            debt: 0,
            loanInterestRate: 0.05,
            loanLimit: 10000
        };
        document.getElementById('build-modal').innerHTML = `
            <div class="modal-content"><h2>å»ºé€ èˆ‡å‡ç´šé¸å–®</h2><div class="modal-body" id="build-modal-body"></div><button class="modal-close-button">é—œé–‰</button></div>`;
        document.getElementById('event-modal').innerHTML = `
            <div class="modal-content"><h2 id="event-modal-title">æ¯æœˆå ±å‘Š</h2><div class="modal-body"><ul id="event-log"></ul></div><button class="modal-close-button">ç¢ºèª</button></div>`;
        document.getElementById('instructions-modal').innerHTML = `
            <div class="modal-content"><h2>ğŸ® æ­¡è¿ä¾†åˆ°é˜²ç½åŸå¸‚æ¨¡æ“¬å™¨ï¼</h2><div class="modal-body"><p><strong>ç©æ³•:</strong> é»æ“Šå³ä¸‹è§’çš„ã€Œ<strong>â¡ï¸ ä¸‹ä¸€æœˆ</strong>ã€æ¨é€²æ™‚é–“ï¼Œé»æ“Šå·¦ä¸‹è§’çš„ã€Œ<strong>âš’ï¸ å»ºé€ </strong>ã€ä¾†å¼·åŒ–ä½ çš„åŸå¸‚ã€‚ç¥ä½ å¥½é‹ï¼Œå¸‚é•·ï¼</p></div><button class="modal-close-button">é–‹å§‹éŠæˆ²</button></div>`;
        document.getElementById('loan-modal').innerHTML = `
            <div class="modal-content">
                <h2>ğŸ’¸ å€Ÿè²¸ä¸­å¿ƒ</h2>
                <div class="modal-body">
                    <p>ç›®å‰å‚µå‹™: <span id="current-debt">${gameState.debt}</span> é‡‘å¹£</p>
                    <p>æ¯æœˆåˆ©æ¯: <span id="current-interest">${gameState.loanInterestRate * 100}%</span></p>
                    <p>å¯å€Ÿè²¸é¤˜é¡: <span id="loan-available">${gameState.loanLimit - gameState.debt}</span> é‡‘å¹£</p>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:20px;">
                        <input type="number" id="loan-amount-input" min="100" value="1000" step="100">
                        <button onclick="takeLoan()">å€Ÿæ¬¾</button>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="number" id="repay-amount-input" min="100" value="1000" step="100">
                        <button onclick="repayLoan()">é‚„æ¬¾</button>
                    </div>
                </div>
                <button class="modal-close-button">é—œé–‰</button>
            </div>`;
        updateUI();
    }

    function updateUI() {
        document.getElementById('month-stat').innerText = `ğŸ“… ç¬¬ ${gameState.currentMonth} æœˆ`;
        document.getElementById('gold-stat').innerText = `ğŸ’° é‡‘å¹£: ${gameState.gold}`;
        const totalPopulation = gameState.population.plains + gameState.population.mountain;
        document.getElementById('population-stat').innerText = `ğŸ§‘â€ğŸ¤â€ğŸ§‘ ç¸½äººå£: ${totalPopulation}`;

        const debtStat = document.getElementById('debt-stat');
        if (gameState.debt > 0) {
            debtStat.style.display = 'flex';
            debtStat.innerText = `ğŸ’¸ å‚µå‹™: ${gameState.debt}`;
        } else {
            debtStat.style.display = 'none';
        }

        document.getElementById('plains-population').innerText = gameState.population.plains;
        document.getElementById('plains-homeless').innerText = gameState.homeless.plains;
        document.getElementById('plains-sick').innerText = gameState.sickness.plains.length;
        document.getElementById('plains-damaged-houses').innerText = gameState.damagedHouses.plains;

        document.getElementById('mountains-population').innerText = gameState.population.mountain;
        document.getElementById('mountains-homeless').innerText = gameState.homeless.mountain;
        document.getElementById('mountains-sick').innerText = gameState.sickness.mountain.length;
        document.getElementById('mountains-damaged-houses').innerText = gameState.damagedHouses.mountain;

        const plainsBuildingsDiv = document.getElementById('plains-buildings');
        const mountainsBuildingsDiv = document.getElementById('mountains-buildings');

        plainsBuildingsDiv.innerHTML = '';
        mountainsBuildingsDiv.innerHTML = '';

        for (const houseKey in houseMaster) {
            const houseInfo = houseMaster[houseKey];
            const houseId = houseInfo.id;

            for (let i = 0; i < gameState.buildings.plains[houseId]; i++) {
                const icon = document.createElement('span');
                icon.className = 'building-icon';
                icon.innerText = houseInfo.icon;
                icon.title = houseInfo.name;
                plainsBuildingsDiv.appendChild(icon);
            }

            for (let i = 0; i < gameState.buildings.mountain[houseId]; i++) {
                const icon = document.createElement('span');
                icon.className = 'building-icon';
                icon.innerText = houseInfo.icon;
                icon.title = houseInfo.name;
                mountainsBuildingsDiv.appendChild(icon);
            }
        }
        for (let i = 0; i < gameState.damagedHouses.plains; i++) {
            const icon = document.createElement('span');
            icon.className = 'building-icon';
            icon.innerText = 'ğŸšï¸';
            icon.title = 'æå£çš„æˆ¿å±‹';
            plainsBuildingsDiv.appendChild(icon);
        }
        for (let i = 0; i < gameState.damagedHouses.mountain; i++) {
            const icon = document.createElement('span');
            icon.className = 'building-icon';
            icon.innerText = 'ğŸšï¸';
            icon.title = 'æå£çš„æˆ¿å±‹';
            mountainsBuildingsDiv.appendChild(icon);
        }

        // --- æ–°å¢ï¼šå‹•æ…‹ç”Ÿæˆè¨­æ–½åœ–ç¤º ---
        for (const facilityKey in facilityMaster) {
            const facilityInfo = facilityMaster[facilityKey];
            const facilityId = facilityInfo.id;

            // é¡¯ç¤ºå¹³åŸè¨­æ–½
            for (let i = 0; i < gameState.facilities.plains[facilityId]; i++) {
                const icon = document.createElement('span');
                icon.className = 'facility-icon';
                icon.innerText = facilityInfo.icon;
                icon.title = facilityInfo.name + ' (å¹³åŸ)';
                plainsBuildingsDiv.appendChild(icon);
            }
            // é¡¯ç¤ºå±±åœ°è¨­æ–½
            for (let i = 0; i < gameState.facilities.mountain[facilityId]; i++) {
                const icon = document.createElement('span');
                icon.className = 'facility-icon';
                icon.innerText = facilityInfo.icon;
                icon.title = facilityInfo.name + ' (å±±åœ°)';
                mountainsBuildingsDiv.appendChild(icon);
            }
        }
    }

    function buildItems(itemId, quantity, area) {
        quantity = parseInt(quantity, 10);
        if (isNaN(quantity) || quantity <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ï¼"); return; }

        if (itemId.startsWith('house')) {
            const cost = houseMaster[Object.keys(houseMaster).find(k => houseMaster[k].id === itemId)].cost;
            const totalCost = cost * quantity;
            if (gameState.gold < totalCost) { alert(`é‡‘å¹£ä¸è¶³ï¼éœ€è¦ ${totalCost}, ä½ åªæœ‰ ${gameState.gold}`); return; }
            gameState.gold -= totalCost;
            gameState.buildings[area][itemId] += quantity; // æˆ¿å±‹åªåœ¨æŒ‡å®šå€åŸŸå»ºé€ 
            gameState.eventLog.push(`ğŸ  åœ¨${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}å»ºé€ äº† ${quantity} æ£Ÿ ${houseMaster[Object.keys(houseMaster).find(k => houseMaster[k].id === itemId)].name}ã€‚`);
        } else if (itemId === 'shelter') {
             const cost = facilityMaster["é¿é›£ä¸­å¿ƒ"].cost;
             const totalCost = cost * quantity;
             if (gameState.gold < totalCost) { alert(`é‡‘å¹£ä¸è¶³ï¼éœ€è¦ ${totalCost}, ä½ åªæœ‰ ${gameState.gold}`); return; }
             gameState.gold -= totalCost;
             gameState.facilities[area].shelter += quantity; // é¿é›£ä¸­å¿ƒæŒ‰å€åŸŸå»ºé€ 
             gameState.eventLog.push(`ğŸ•ï¸ åœ¨${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}å»ºé€ äº† ${quantity} å€‹é¿é›£ä¸­å¿ƒã€‚`);
        }
        updateUI();
        populateBuildModal();
    }

    function repairHouses(area, quantity) {
        quantity = parseInt(quantity, 10);
        if (isNaN(quantity) || quantity <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ï¼"); return; }
        if (quantity > gameState.damagedHouses[area]) { alert(`${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}æ²’æœ‰é‚£éº¼å¤šæå£æˆ¿å±‹å¯ä¾›ä¿®å¾©ï¼`); return; }

        const repairCostPerHouse = 500;
        const totalRepairCost = repairCostPerHouse * quantity;

        if (gameState.gold < totalRepairCost) { alert(`é‡‘å¹£ä¸è¶³ï¼éœ€è¦ ${totalRepairCost}, ä½ åªæœ‰ ${gameState.gold}`); return; }

        gameState.gold -= totalRepairCost;
        gameState.damagedHouses[area] -= quantity;
        gameState.buildings[area].house1 += quantity;
        gameState.eventLog.push(`ğŸ› ï¸ ä¿®å¾©äº† ${quantity} æ£Ÿ ${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}çš„æˆ¿å±‹ã€‚`);
        updateUI();
        populateBuildModal();
    }


    function upgradeFacility(facilityId, area) { // æ¥æ”¶ area åƒæ•¸
        const facility = facilityMaster[Object.keys(facilityMaster).find(k => facilityMaster[k].id === facilityId)];

        // æª¢æŸ¥è©²å€åŸŸçš„è¨­æ–½ç­‰ç´š
        if (gameState.facilities[area][facilityId] >= 3) {
            alert(`${facility.name} (${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}) å·²é”æœ€é«˜ç­‰ç´šï¼`);
            return;
        }

        const cost = facility.cost;
        if (gameState.gold < cost) { alert(`é‡‘å¹£ä¸è¶³ï¼éœ€è¦ ${cost}, ä½ åªæœ‰ ${gameState.gold}`); return; }

        gameState.gold -= cost;
        gameState.facilities[area][facilityId]++; // è¨­æ–½æŒ‰å€åŸŸå‡ç´š
        gameState.eventLog.push(`â¬†ï¸ åœ¨${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}å‡ç´šäº† ${facility.name} åˆ° ${gameState.facilities[area][facilityId]} éšã€‚`);
        updateUI();
        populateBuildModal();
    }

    function takeLoan() {
        let amount = parseInt(document.getElementById('loan-amount-input').value, 10);
        if (isNaN(amount) || amount <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å€Ÿè²¸é‡‘é¡ï¼"); return; }
        if (gameState.debt + amount > gameState.loanLimit) { alert(`å€Ÿè²¸ç¸½é¡ä¸èƒ½è¶…éä¸Šé™ ${gameState.loanLimit} é‡‘å¹£ï¼`); return; }

        gameState.gold += amount;
        gameState.debt += amount;
        gameState.eventLog.push(`ğŸ’¸ å€Ÿæ¬¾ ${amount} é‡‘å¹£ï¼Œç•¶å‰å‚µå‹™ ${gameState.debt} é‡‘å¹£ã€‚`);
        updateUI();
        populateLoanModal();
    }

    function repayLoan() {
        let amount = parseInt(document.getElementById('repay-amount-input').value, 10);
        if (isNaN(amount) || amount <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‚„æ¬¾é‡‘é¡ï¼"); return; }
        if (amount > gameState.debt) { amount = gameState.debt; }
        if (gameState.gold < amount) { alert(`é‡‘å¹£ä¸è¶³ä»¥æ”¯ä»˜ ${amount} é‡‘å¹£çš„é‚„æ¬¾ï¼`); return; }

        gameState.gold -= amount;
        gameState.debt -= amount;
        gameState.eventLog.push(`âœ… é‚„æ¬¾ ${amount} é‡‘å¹£ï¼Œå‰©é¤˜å‚µå‹™ ${gameState.debt} é‡‘å¹£ã€‚`);
        updateUI();
        populateLoanModal();
    }

    function runMonthlySimulation() {
        if (gameState.population.plains <= 0 && gameState.population.mountain <= 0) { showEventModal("éŠæˆ²çµæŸ", ["æ‰€æœ‰äººéƒ½æ­»äº¡äº†... åŸå¸‚æ¯€æ»…ï¼"]); return; }
        if (gameState.currentMonth >= 12) { showEventModal("éŠæˆ²çµæŸ", ["æ­å–œä½ ï¼ŒæˆåŠŸæ’éäº†12å€‹æœˆï¼ä½ çš„åŸå¸‚ç¹æ¦®æ˜Œç››ï¼"]); return; }

        gameState.currentMonth++;
        gameState.eventLog = [];

        // é¿é›£ä¸­å¿ƒåœ¨ç•¶æœˆç”¢ç”Ÿæ•ˆæœå¾Œæ¸…ç©º
        gameState.facilities.plains.shelter = 0;
        gameState.facilities.mountain.shelter = 0;
        gameState.facilities.global.shelter = 0;

        // æ›´æ–°å…¨åŸŸè¨­æ–½ç¸½æ•¸
        gameState.facilities.global.hospital = gameState.facilities.plains.hospital + gameState.facilities.mountain.hospital;
        gameState.facilities.global.earthquakeWarning = gameState.facilities.plains.earthquakeWarning + gameState.facilities.mountain.earthquakeWarning;
        // é¿é›£ä¸­å¿ƒç¸½æ•¸åœ¨æ¯æœˆæ¨¡æ“¬é–‹å§‹æ™‚æ­¸é›¶ï¼Œåœ¨äº‹ä»¶ä¸­ï¼ˆå¦‚äººå£é·å¾™ï¼‰æœƒè‡¨æ™‚å¢åŠ ã€‚
        // æ‰€ä»¥é€™è£¡ä¸éœ€è¦å¾å…©å€è¨­æ–½ç´¯åŠ ï¼Œå®ƒæ˜¯ä¸€å€‹ã€Œè‡¨æ™‚åº‡è­·ã€çš„æ¦‚å¿µã€‚
        // å¦‚æœæ‚¨å¸Œæœ›é¿é›£ä¸­å¿ƒæ˜¯æ°¸ä¹…å»ºç¯‰ä¸¦æœ‰æŒçºŒæ•ˆæœï¼Œéœ€è¦èª¿æ•´å…¶åœ¨ gameState ä¸­çš„ç®¡ç†æ–¹å¼ã€‚
        // ä½†ç›®å‰éŠæˆ²é‚è¼¯ä¸­ï¼Œé¿é›£ä¸­å¿ƒæ˜¯åœ¨ç½å®³ç™¼ç”Ÿå¾Œæä¾›è‡¨æ™‚ä½æ‰€ï¼Œä¸‹æ¬¡ç½å®³ç™¼ç”Ÿå‰æœƒè¢«ã€Œæ¸…ç©ºã€ã€‚
        // å¦‚æœé¿é›£ä¸­å¿ƒæ˜¯è¢«å»ºé€ çš„ï¼Œé‚£å®ƒæ‡‰è©²æ˜¯æ°¸ä¹…çš„ï¼Œæ‰€ä»¥é€™è£¡ä¿®æ­£ç‚ºç´¯åŠ 
        gameState.facilities.global.shelter = gameState.facilities.plains.shelter + gameState.facilities.mountain.shelter;


        // ç½å®³èˆ‡äº‹ä»¶è™•ç†
        let isRain = false, isHeavyRain = false;
        const monthMod12 = gameState.currentMonth % 12 || 12;
        let rainChance = 0.4;
        if ([5, 6, 7, 8].includes(monthMod12)) rainChance = 0.65;
        if (Math.random() < rainChance) {
            isRain = true;
            if ([7, 8].includes(monthMod12) && Math.random() < 0.8) {
                isHeavyRain = true;
                gameState.eventLog.push("ğŸŒ©ï¸ æœ¬æœˆç‚ºæš´é›¨ï¼");
                // gameState.rainCount = 0; // é€™è¡Œä¸æ‡‰è©²åœ¨é€™è£¡ï¼Œæš´é›¨å¾Œé›¨é‡æ‡‰è©²ç¹¼çºŒç´¯ç©
            } else {
                gameState.eventLog.push("ğŸŒ§ï¸ æœ¬æœˆæœ‰ä¸‹é›¨ã€‚");
            }
            gameState.rainCount++; // ç„¡è«–å¤§å°é›¨ï¼Œé›¨é‡éƒ½ç´¯ç©
        } else {
            gameState.rainCount = 0; // æ²’æœ‰ä¸‹é›¨å‰‡é‡ç½®
        }

        let hadEarthquake = false;
        if (Math.random() < 0.3) {
            hadEarthquake = true;
            const isMajor = Math.random() < 0.15;
            let earthquakeMsg = isMajor ? "ğŸ’¥ ç™¼ç”Ÿã€å¤§åœ°éœ‡ã€‘ï¼" : "ğŸŒ ç™¼ç”Ÿã€åœ°éœ‡ã€‘ï¼";
            // åœ°éœ‡é è­¦ç³»çµ±æ•ˆæœç¾åœ¨ä¾†è‡ªå…¨åŸŸçµ±è¨ˆ
            let reduction = 1 - (0.2 * gameState.facilities.global.earthquakeWarning);
            // åœ°éœ‡å°æˆ¿å±‹çš„å½±éŸ¿ç¾åœ¨åªé‡å°ä¸€ç´šæˆ¿å±‹ï¼Œæ–¹ä¾¿ä¿®å¾©
            let damageFactor = isMajor ? 0.4 : 0.2;
            let finalDamage = damageFactor * reduction;

            // è¨ˆç®—å…©å€æˆ¿å±‹æå£é‡
            const plainsHousesToDestroy = Math.round(gameState.buildings.plains.house1 * finalDamage);
            const mountainHousesToDestroy = Math.round(gameState.buildings.mountain.house1 * finalDamage);

            gameState.buildings.plains.house1 -= plainsHousesToDestroy;
            gameState.damagedHouses.plains += plainsHousesToDestroy;
            gameState.buildings.mountain.house1 -= mountainHousesToDestroy;
            gameState.damagedHouses.mountain += mountainHousesToDestroy;

            // è¨ˆç®—æ­»äº¡äººæ•¸
            let deaths = Math.round((gameState.population.plains + gameState.population.mountain) * finalDamage * 0.1);
            deaths = Math.max(0, deaths - gameState.facilities.global.shelter * 5); // é¿é›£ä¸­å¿ƒæ¸›å°‘æ­»äº¡

            gameState.population.plains -= Math.round(deaths / 2);
            gameState.population.mountain -= Math.round(deaths / 2);
            earthquakeMsg += ` é€ æˆäº†è¨­æ–½ææ¯€èˆ‡ ${deaths} äººæ­»äº¡ï¼Œ${plainsHousesToDestroy + mountainHousesToDestroy} æ£Ÿæˆ¿å±‹æå£ã€‚`;
            gameState.eventLog.push(earthquakeMsg);
        }

        let isSoilLoose = (gameState.rainCount >= 3) || hadEarthquake;
        if (isSoilLoose || isHeavyRain) {
            // æ“‹åœŸç‰†æ•ˆæœåªåœ¨å±±åœ°è¨­æ–½ä¸­è¨ˆç®—
            let reduction = 1 - (0.3 * gameState.facilities.mountain.retainingWall);
            let damageFactor = isHeavyRain ? 0.5 : 0.2;
            let finalDamage = damageFactor * reduction;
            let deaths = Math.round(gameState.population.mountain * finalDamage);
            deaths = Math.max(0, deaths - gameState.facilities.global.shelter * 5); // é¿é›£ä¸­å¿ƒæ¸›å°‘æ­»äº¡
            gameState.population.mountain -= deaths;

            let destroyedHouses = Math.round(gameState.buildings.mountain.house1 * finalDamage);
            gameState.buildings.mountain.house1 -= destroyedHouses;
            gameState.damagedHouses.mountain += destroyedHouses;

            gameState.eventLog.push(`â›°ï¸ ç™¼ç”ŸåœŸçŸ³æµï¼å±±å€æ­»äº¡ ${deaths} äººï¼Œææ¯€ ${destroyedHouses} æ£Ÿæˆ¿å±‹ã€‚`);
            // gameState.rainCount = 0; // åœŸçŸ³æµå¾Œé›¨é‡ä¸ä¸€å®šæ­¸é›¶
        }

        if (gameState.rainCount >= 3 || isHeavyRain) {
            // æ°´å£©æ•ˆæœåªåœ¨å¹³åœ°è¨­æ–½ä¸­è¨ˆç®—
            let reduction = 1 - (0.33 * gameState.facilities.plains.dam);
            let damageFactor = isHeavyRain ? 0.3 : 0.15;
            let finalDamage = damageFactor * reduction;
            let deaths = Math.round(gameState.population.plains * finalDamage);
            deaths = Math.max(0, deaths - gameState.facilities.global.shelter * 5); // é¿é›£ä¸­å¿ƒæ¸›å°‘æ­»äº¡
            gameState.population.plains -= deaths;

            let destroyedHouses = Math.round(gameState.buildings.plains.house1 * finalDamage);
            gameState.buildings.plains.house1 -= destroyedHouses;
            gameState.damagedHouses.plains += destroyedHouses;

            gameState.eventLog.push(`ğŸŒŠ ç™¼ç”Ÿæ·¹æ°´ï¼å¹³åŸæ­»äº¡ ${deaths} äººï¼Œææ¯€ ${destroyedHouses} æ£Ÿæˆ¿å±‹ã€‚`);
            // gameState.rainCount = 0; // æ·¹æ°´å¾Œé›¨é‡ä¸ä¸€å®šæ­¸é›¶
        }

        if (gameState.currentMonth === gameState.majorDisasterMonth) {
            gameState.eventLog.push(`ğŸ†˜ è­¦å‘Šï¼æœ¬æœˆç™¼ç”Ÿã€${gameState.majorDisasterType}ã€‘ï¼ï¼`);
            if (gameState.majorDisasterType === "ç«å±±çˆ†ç™¼") {
                let deaths = Math.round(gameState.population.mountain * 0.75);
                deaths = Math.max(0, deaths - gameState.facilities.global.shelter * 10); // é¿é›£ä¸­å¿ƒå°é‡å¤§ç½å®³çš„æ­»äº¡å½±éŸ¿æ›´å¤§
                gameState.population.mountain -= deaths;

                // æ‰€æœ‰å±±åœ°æˆ¿å±‹æå£
                let totalMountainHouses = gameState.buildings.mountain.house1 + gameState.buildings.mountain.house2 + gameState.buildings.mountain.house3;
                gameState.damagedHouses.mountain += totalMountainHouses;
                gameState.buildings.mountain.house1 = 0;
                gameState.buildings.mountain.house2 = 0;
                gameState.buildings.mountain.house3 = 0;

                // ç«å±±çˆ†ç™¼ä¹Ÿæœƒç ´å£å±±åœ°è¨­æ–½
                for (const facilityId in gameState.facilities.mountain) {
                    gameState.facilities.mountain[facilityId] = 0;
                }
                gameState.eventLog.push(`ğŸŒ‹ å±±åœ°è¢«ç«å±±ç°è¦†è“‹ï¼Œæ­»äº¡ ${deaths} äººï¼Œå»ºç¯‰èˆ‡è¨­æ–½å…¨æ¯€ï¼`);
            } else { // éš•çŸ³æ‰è½ æˆ– è¶…ç´šé¢±é¢¨
                let deaths = Math.round((gameState.population.plains + gameState.population.mountain) * 0.3);
                deaths = Math.max(0, deaths - gameState.facilities.global.shelter * 10); // é¿é›£ä¸­å¿ƒå°é‡å¤§ç½å®³çš„æ­»äº¡å½±éŸ¿æ›´å¤§
                gameState.population.plains -= Math.round(deaths / 2);
                gameState.population.mountain -= Math.round(deaths / 2);

                const plainsHousesDestroyed = Math.round((gameState.buildings.plains.house1 + gameState.buildings.plains.house2 + gameState.buildings.plains.house3) * 0.5);
                const mountainHousesDestroyed = Math.round((gameState.buildings.mountain.house1 + gameState.buildings.mountain.house2 + gameState.buildings.mountain.house3) * 0.5);

                gameState.buildings.plains.house1 -= plainsHousesDestroyed;
                gameState.damagedHouses.plains += plainsHousesDestroyed;
                gameState.buildings.mountain.house1 -= mountainHousesDestroyed;
                gameState.damagedHouses.mountain += mountainHousesDestroyed;

                // éš•çŸ³æˆ–è¶…ç´šé¢±é¢¨å°å…©å€è¨­æ–½é€ æˆæå£
                for (const facilityId in gameState.facilities.plains) {
                    // åªææ¯€è©²å€åŸŸå·²æœ‰çš„è¨­æ–½ï¼Œè€Œä¸æ˜¯å°‡æ‰€æœ‰è¨­æ–½é¡å‹éƒ½æ­¸é›¶
                    if (gameState.facilities.plains[facilityId] > 0) {
                        gameState.facilities.plains[facilityId] = Math.max(0, Math.round(gameState.facilities.plains[facilityId] * 0.5));
                    }
                }
                for (const facilityId in gameState.facilities.mountain) {
                    if (gameState.facilities.mountain[facilityId] > 0) {
                        gameState.facilities.mountain[facilityId] = Math.max(0, Math.round(gameState.facilities.mountain[facilityId] * 0.5));
                    }
                }

                gameState.eventLog.push(`â˜„ï¸ å…¨å€é­å—é‡å‰µï¼Œç¸½å…±æ­»äº¡ ${deaths} äººï¼Œ${plainsHousesDestroyed + mountainHousesDestroyed} æ£Ÿæˆ¿å±‹æå£ï¼Œéƒ¨åˆ†è¨­æ–½ææ¯€ï¼`);
            }
            // é‡ç½®ä¸‹ä¸€å€‹é‡å¤§ç½å®³æœˆä»½å’Œé¡å‹
            gameState.majorDisasterMonth = gameState.currentMonth + Math.floor(Math.random() * 6) + 6; // ä¸‹ä¸€å€‹ç½å®³åœ¨æœªä¾†6-11å€‹æœˆå…§
            gameState.majorDisasterType = ["ç«å±±çˆ†ç™¼", "éš•çŸ³æ‰è½", "è¶…ç´šé¢±é¢¨"][Math.floor(Math.random() * 3)];
        }

        handleRandomEvents();

        for (const area of ['plains', 'mountain']) {
            const healthyPop = gameState.population[area] - gameState.sickness[area].length;
            const newSick = Math.floor(healthyPop * (area === 'mountain' ? 0.08 : 0.05));
            for(let i=0; i<newSick; i++) gameState.sickness[area].push(0);
            for(let i=0; i<gameState.homeless[area]; i++) gameState.sickness[area].push(0);
        }

        let sickDeaths = { plains: 0, mountain: 0 };
        for (const area of ['plains', 'mountain']) {
            let survivors = [];
            for (const duration of gameState.sickness[area]) {
                if (duration > 3) {
                    sickDeaths[area]++;
                } else {
                    survivors.push(duration + 1);
                }
            }
            gameState.sickness[area] = survivors;
            gameState.population[area] -= sickDeaths[area];
        }

        if (sickDeaths.plains > 0) gameState.eventLog.push(`â˜ ï¸ å¹³åœ°æœ‰ ${sickDeaths.plains} äººå› ç—…æ­»äº¡ã€‚`);
        if (sickDeaths.mountain > 0) gameState.eventLog.push(`â˜ ï¸ å±±åœ°æœ‰ ${sickDeaths.mountain} äººå› ç—…æ­»äº¡ã€‚`);

        // é†«é™¢æ²»ç™‚èƒ½åŠ›ç¾åœ¨ä¾†è‡ªå…¨åŸŸçµ±è¨ˆ
        let capacity = [0, 10, 14, 20][gameState.facilities.global.hospital] || 0;
        let treated = 0;
        for (const area of ['plains', 'mountain']) {
            let treatable = Math.min(gameState.sickness[area].length, capacity - treated);
            gameState.sickness[area].splice(0, treatable);
            treated += treatable;
        }
        if (treated > 0) gameState.eventLog.push(`ğŸ¥ é†«é™¢æœ¬æœˆæ²»ç™‚äº† ${treated} ä½ç—…äººã€‚`);

        let income = 0;
        for (const area of ['plains', 'mountain']) {
            const pop = gameState.population[area];
            const sick = gameState.sickness[area].length;
            const base = area === 'plains' ? (pop - sick) * 100 + sick * 50 : (pop - sick) * 200 + sick * 100;
            income += base;
        }
        // è¾²ç”°å’Œç¤¦å ´æ”¶å…¥åŠ æˆç¾åœ¨ä¾†è‡ªå€åŸŸè¨­æ–½ç¸½å’Œ
        income *= (1 + (0.15 * gameState.facilities.plains.farm));
        income *= (1 + (0.3 * gameState.facilities.mountain.mine));
        income = Math.round(income);
        gameState.gold += income;
        gameState.eventLog.push(`ğŸ’° æœ¬æœˆç¸½æ”¶å…¥ç‚º ${income} é‡‘å¹£ã€‚`);

        // è™•ç†å‚µå‹™åˆ©æ¯
        if (gameState.debt > 0) {
            const interest = Math.round(gameState.debt * gameState.loanInterestRate);
            gameState.gold -= interest;
            gameState.eventLog.push(`ğŸ’¸ æ”¯ä»˜äº† ${interest} é‡‘å¹£çš„å€Ÿè²¸åˆ©æ¯ã€‚`);
            if (gameState.gold < 0) {
                const deficit = Math.abs(gameState.gold);
                gameState.debt += deficit;
                gameState.gold = 0;
                gameState.eventLog.push(`ğŸš¨ è³‡é‡‘ä¸è¶³ï¼Œå‚µå‹™å¢åŠ  ${deficit} é‡‘å¹£ã€‚`);
            }
        }

        for (const area of ['plains', 'mountain']) {
            const healthy = gameState.population[area] - gameState.sickness[area].length;
            const growth = Math.round(healthy * (area === 'plains' ? 0.15 : 0.2));
            gameState.population[area] += growth;
            if(growth > 0) gameState.eventLog.push(`ğŸ‘¶ ${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}äººå£è‡ªç„¶å¢é•·äº† ${growth} äººã€‚`);
        }

        for (const area of ['plains', 'mountain']) {
            const capacity = gameState.buildings[area].house1 * 5 + gameState.buildings[area].house2 * 10 + gameState.buildings[area].house3 * 20;
            gameState.homeless[area] = Math.max(0, gameState.population[area] - capacity);
            if (gameState.homeless[area] > 0) {
                gameState.eventLog.push(`ğŸš« ${area === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}æœ‰ ${gameState.homeless[area]} äººå±…ç„¡å®šæ‰€ï¼`);
            }
        }

        for (const area of ['plains', 'mountain']) { gameState.population[area] = Math.max(0, gameState.population[area]); }

        // ç¢ºä¿å½ˆå‡ºè¦–çª—é¡¯ç¤º
        updateUI();
        showEventModal(`ç¬¬ ${gameState.currentMonth} æœˆå ±å‘Š`, gameState.eventLog);
    }

    function handleRandomEvents() {
        const randomEventChance = 0.2;
        if (Math.random() < randomEventChance) {
            const eventTypes = [
                "mildSickness",
                "smallFire",
                "resourceShortage",
                "populationBoom",
                "goldVein",
                "medicalBreakthrough",
                "noEvent" // æ–°å¢ä¸€å€‹ã€Œæ²’æœ‰ç‰¹æ®Šäº‹ä»¶ã€çš„é¸é …ï¼Œè®“éŠæˆ²ä¸é‚£éº¼é »ç¹åœ°ç™¼ç”Ÿäº‹
            ];
            const chosenEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];

            switch (chosenEvent) {
                case "mildSickness":
                    const sickPop = Math.round((gameState.population.plains + gameState.population.mountain) * 0.03);
                    for (let i = 0; i < sickPop; i++) {
                        if (Math.random() < 0.6) gameState.sickness.plains.push(0);
                        else gameState.sickness.mountain.push(0);
                    }
                    if (sickPop > 0) { // åªæœ‰ç•¶æœ‰äººç”Ÿç—…æ™‚æ‰è¨˜éŒ„äº‹ä»¶
                        gameState.eventLog.push(`ğŸ˜· åŸå¸‚çˆ†ç™¼è¼•å¾®å‚³æŸ“ç—…ï¼Œç´„ ${sickPop} äººç”Ÿç—…ã€‚`);
                    } else {
                        // å¦‚æœæ²’æœ‰äººç”Ÿç—…ï¼Œå‰‡è¦–ç‚ºæ²’æœ‰ç‰¹æ®Šäº‹ä»¶
                        gameState.eventLog.push(`å¹¸é‹çš„æ˜¯ï¼Œæœ¬æœˆæ²’æœ‰ç™¼ç”Ÿä»€éº¼ç‰¹åˆ¥çš„äº‹ã€‚`);
                    }
                    break;
                case "smallFire":
                    const affectedArea = Math.random() < 0.5 ? 'plains' : 'mountain';
                    // ç¢ºä¿æœ‰æˆ¿å±‹å¯ä»¥è¢«ç‡’æ¯€
                    const availableHouses = gameState.buildings[affectedArea].house1 + gameState.buildings[affectedArea].house2 + gameState.buildings[affectedArea].house3;
                    if (availableHouses > 0) {
                        const housesBurned = Math.min(Math.ceil(availableHouses * 0.1), 5); // æœ€å¤šç‡’æ¯€5æ£Ÿ
                        if (housesBurned > 0) {
                            // å„ªå…ˆå¾ä½ç´šæˆ¿å±‹ç‡’æ¯€ï¼Œä¸¦è½‰ç‚ºæå£æˆ¿å±‹
                            let remainingToBurn = housesBurned;
                            if (gameState.buildings[affectedArea].house1 >= remainingToBurn) {
                                gameState.buildings[affectedArea].house1 -= remainingToBurn;
                                gameState.damagedHouses[affectedArea] += remainingToBurn;
                                remainingToBurn = 0;
                            } else {
                                gameState.damagedHouses[affectedArea] += gameState.buildings[affectedArea].house1;
                                remainingToBurn -= gameState.buildings[affectedArea].house1;
                                gameState.buildings[affectedArea].house1 = 0;
                            }
                            if (remainingToBurn > 0 && gameState.buildings[affectedArea].house2 >= remainingToBurn) {
                                gameState.buildings[affectedArea].house2 -= remainingToBurn;
                                gameState.damagedHouses[affectedArea] += remainingToBurn;
                                remainingToBurn = 0;
                            } else if (remainingToBurn > 0) {
                                gameState.damagedHouses[affectedArea] += gameState.buildings[affectedArea].house2;
                                remainingToBurn -= gameState.buildings[affectedArea].house2;
                                gameState.buildings[affectedArea].house2 = 0;
                            }
                            if (remainingToBurn > 0 && gameState.buildings[affectedArea].house3 >= remainingToBurn) {
                                gameState.buildings[affectedArea].house3 -= remainingToBurn;
                                gameState.damagedHouses[affectedArea] += remainingToBurn;
                                remainingToBurn = 0;
                            } else if (remainingToBurn > 0) {
                                gameState.damagedHouses[affectedArea] += gameState.buildings[affectedArea].house3;
                                remainingToBurn -= gameState.buildings[affectedArea].house3;
                                gameState.buildings[affectedArea].house3 = 0;
                            }

                            gameState.eventLog.push(`ğŸ”¥ ${affectedArea === 'plains' ? 'å¹³åœ°' : 'å±±åœ°'}ç™¼ç”Ÿå°å‹ç«ç½ï¼Œ${housesBurned} æ£Ÿæˆ¿å±‹æå£ã€‚`);
                        } else {
                            gameState.eventLog.push(`å¹¸é‹çš„æ˜¯ï¼Œæœ¬æœˆæ²’æœ‰ç™¼ç”Ÿä»€éº¼ç‰¹åˆ¥çš„äº‹ã€‚`);
                        }
                    } else {
                         gameState.eventLog.push(`å¹¸é‹çš„æ˜¯ï¼Œæœ¬æœˆæ²’æœ‰ç™¼ç”Ÿä»€éº¼ç‰¹åˆ¥çš„äº‹ã€‚`);
                    }
                    break;
                case "resourceShortage":
                    const incomeReduction = Math.round(gameState.gold * 0.1);
                    gameState.gold -= incomeReduction;
                    gameState.eventLog.push(`ğŸ“‰ æœ¬æœˆé­é‡è³‡æºçŸ­ç¼ºï¼Œæ”¶å…¥æ¸›å°‘ ${incomeReduction} é‡‘å¹£ã€‚`);
                    break;
                case "populationBoom":
                    const newPopulation = Math.round((gameState.population.plains + gameState.population.mountain) * 0.05);
                    gameState.population.plains += Math.round(newPopulation / 2);
                    gameState.population.mountain += Math.round(newPopulation / 2);
                    gameState.eventLog.push(`ğŸ‰ å¤§é‡äººå£é·å…¥ï¼ŒåŸå¸‚æ–°å¢ ${newPopulation} äººï¼`);
                    break;
                case "goldVein":
                    const bonusGold = Math.floor(Math.random() * 2000) + 1000;
                    gameState.gold += bonusGold;
                    gameState.eventLog.push(`âœ¨ æŒ–åˆ°é‡‘ç¤¦è„ˆï¼Œé¡å¤–ç²å¾— ${bonusGold} é‡‘å¹£ï¼`);
                    break;
                case "medicalBreakthrough":
                    const totalSick = gameState.sickness.plains.length + gameState.sickness.mountain.length;
                    const treatedPatients = Math.min(Math.floor(totalSick * 0.3), 20);
                    if (treatedPatients > 0) {
                        for (let i = 0; i < treatedPatients; i++) {
                            // å„ªå…ˆæ²»ç™‚å¹³åœ°ç—…äººï¼Œå¦‚æœå¹³åœ°æ²’ç—…äººäº†å°±æ²»ç™‚å±±åœ°
                            if (gameState.sickness.plains.length > 0) {
                                gameState.sickness.plains.pop();
                            } else if (gameState.sickness.mountain.length > 0) {
                                gameState.sickness.mountain.pop();
                            } else {
                                break;
                            }
                        }
                        gameState.eventLog.push(`ğŸ‘¨â€âš•ï¸ é†«ç™‚æŠ€è¡“çªç ´ï¼Œé¡å¤–æ²»ç™’äº† ${treatedPatients} ä½ç—…äººï¼`);
                    } else {
                        gameState.eventLog.push(`å¹¸é‹çš„æ˜¯ï¼Œæœ¬æœˆæ²’æœ‰ç™¼ç”Ÿä»€éº¼ç‰¹åˆ¥çš„äº‹ã€‚`);
                    }
                    break;
                case "noEvent":
                default:
                    gameState.eventLog.push(`å¹¸é‹çš„æ˜¯ï¼Œæœ¬æœˆæ²’æœ‰ç™¼ç”Ÿä»€éº¼ç‰¹åˆ¥çš„äº‹ã€‚`);
            }
        }
    }


    function populateBuildModal() {
        const body = document.getElementById('build-modal-body');

        let houseBuildHtml = `<div class="build-category"><h3>ğŸ  å»ºé€ æˆ¿å±‹</h3>`;
        for (const hKey in houseMaster) {
            const h = houseMaster[hKey];
            houseBuildHtml += `
                <div class="build-item">
                    <div>
                        <div class="build-item-name">${h.name}</div>
                        <div class="build-item-cost">æˆæœ¬: ${h.cost}</div>
                    </div>
                    <div class="build-controls">
                        <input type="number" id="input-${h.id}-plains" min="1" value="1">
                        <button onclick="buildItems('${h.id}', document.getElementById('input-${h.id}-plains').value, 'plains')">å¹³åœ°å»ºé€ </button>
                        <input type="number" id="input-${h.id}-mountain" min="1" value="1">
                        <button onclick="buildItems('${h.id}', document.getElementById('input-${h.id}-mountain').value, 'mountain')">å±±åœ°å»ºé€ </button>
                    </div>
                </div>`;
        }
        houseBuildHtml += `</div>`;

        let facilityUpgradeHtml = `<div class="build-category"><h3>ğŸ”§ å‡ç´šè¨­æ–½</h3>`;
        for (const fKey in facilityMaster) {
            const f = facilityMaster[fKey];
            if (f.id === 'shelter') { // é¿é›£ä¸­å¿ƒå–®ç¨è™•ç†å»ºé€ 
                facilityUpgradeHtml += `
                    <div class="build-item">
                        <div>
                            <div class="build-item-name">${f.name}</div>
                            <div class="build-item-cost">æˆæœ¬: ${f.cost}</div>
                        </div>
                        <div class="build-controls">
                            <input type="number" id="input-${f.id}-plains" min="1" value="1">
                            <button onclick="buildItems('${f.id}', document.getElementById('input-${f.id}-plains').value, 'plains')">å¹³åœ°å»ºé€ </button>
                            <input type="number" id="input-${f.id}-mountain" min="1" value="1">
                            <button onclick="buildItems('${f.id}', document.getElementById('input-${f.id}-mountain').value, 'mountain')">å±±åœ°å»ºé€ </button>
                        </div>
                    </div>`;
                continue;
            }

            let plainsButton = '';
            let mountainButton = '';

            // æ ¹æ“šè¨­æ–½çš„ area å±¬æ€§ç”ŸæˆæŒ‰éˆ•
            if (f.area === 'plains' || f.area === 'any') {
                plainsButton = `<button class="upgrade-button" onclick="upgradeFacility('${f.id}', 'plains')" ${gameState.facilities.plains[f.id] >= 3 ? 'disabled' : ''}>å¹³åœ°å‡ç´š (Lv:${gameState.facilities.plains[f.id]})</button>`;
            }
            if (f.area === 'mountain' || f.area === 'any') {
                mountainButton = `<button class="upgrade-button" onclick="upgradeFacility('${f.id}', 'mountain')" ${gameState.facilities.mountain[f.id] >= 3 ? 'disabled' : ''}>å±±åœ°å‡ç´š (Lv:${gameState.facilities.mountain[f.id]})</button>`;
            }

            facilityUpgradeHtml += `
                <div class="build-item">
                    <div>
                        <div class="build-item-name">${f.name}</div>
                        <div class="build-item-cost">æˆæœ¬: ${f.cost}</div>
                    </div>
                    <div class="build-controls">
                        ${plainsButton}
                        ${mountainButton}
                    </div>
                </div>`;
        }
        facilityUpgradeHtml += `</div>`;


        let repairHtml = `
        <div class="build-category">
            <h3>ğŸ› ï¸ ä¿®å¾©æˆ¿å±‹</h3>
            <div class="build-item">
                <div>
                    <div class="build-item-name">ä¿®å¾©å¹³åœ°æˆ¿å±‹</div>
                    <div class="build-item-cost">æˆæœ¬: 500 / æ£Ÿ</div>
                </div>
                <div class="build-controls">
                    <input type="number" id="input-repair-plains" min="1" value="1" max="${gameState.damagedHouses.plains}">
                    <button class="repair-button" onclick="repairHouses('plains', document.getElementById('input-repair-plains').value)" ${gameState.damagedHouses.plains === 0 ? 'disabled' : ''}>ä¿®å¾© (${gameState.damagedHouses.plains} æå£)</button>
                </div>
            </div>
            <div class="build-item">
                <div>
                    <div class="build-item-name">ä¿®å¾©å±±åœ°æˆ¿å±‹</div>
                    <div class="build-item-cost">æˆæœ¬: 500 / æ£Ÿ</div>
                </div>
                <div class="build-controls">
                    <input type="number" id="input-repair-mountains" min="1" value="1" max="${gameState.damagedHouses.mountain}">
                    <button class="repair-button" onclick="repairHouses('mountain', document.getElementById('input-repair-mountains').value)" ${gameState.damagedHouses.mountain === 0 ? 'disabled' : ''}>ä¿®å¾© (${gameState.damagedHouses.mountain} æå£)</button>
                </div>
            </div>
        </div>`;

        body.innerHTML = houseBuildHtml + facilityUpgradeHtml + repairHtml;
    }

    function populateLoanModal() {
        document.getElementById('current-debt').innerText = gameState.debt;
        document.getElementById('loan-available').innerText = gameState.loanLimit - gameState.debt;
        document.getElementById('loan-amount-input').max = gameState.loanLimit - gameState.debt;
        document.getElementById('repay-amount-input').max = gameState.debt;
    }

    // æ–°å¢ showEventModal å‡½æ•¸
    function showEventModal(title, events) {
        const modal = document.getElementById('event-modal');
        const titleElement = modal.querySelector('h2');
        const eventLogList = modal.querySelector('#event-log');

        titleElement.innerText = title;
        eventLogList.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„äº‹ä»¶

        if (events.length === 0) {
            eventLogList.innerHTML = '<li>æœ¬æœˆé¢¨å¹³æµªéœï¼Œæ²’æœ‰ç‰¹åˆ¥äº‹ä»¶ç™¼ç”Ÿã€‚</li>';
        } else {
            events.forEach(event => {
                const li = document.createElement('li');
                li.innerText = event;
                eventLogList.appendChild(li);
            });
        }
        modal.classList.add('visible');
    }

    document.getElementById('build-button').addEventListener('click', () => {
        populateBuildModal();
        document.getElementById('build-modal').classList.add('visible');
    });
    document.getElementById('next-month-button').addEventListener('click', runMonthlySimulation);

    document.getElementById('loan-button').addEventListener('click', () => {
        populateLoanModal();
        document.getElementById('loan-modal').classList.add('visible');
    });

    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-button')) {
                modal.classList.remove('visible');
            }
        });
    });
    resetGame();
    </script>
</body>
</html>
